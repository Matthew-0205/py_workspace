# from pymodbus.server import StartSerialServer
# from pymodbus.datastore import ModbusSlaveContext, ModbusServerContext
# import logging
# from pymodbus.datastore import ModbusSequentialDataBlock, ModbusSparseDataBlock
# from pymodbus.datastore import ModbusSlaveContext, ModbusServerContext
# # Enable debug logging
# logging.basicConfig()
# log = logging.getLogger()
# log.setLevel(logging.DEBUG)
# store = ModbusSlaveContext(
#     hr=ModbusSequentialDataBlock(40000, 
#     [0,
#     0x5375, 0x6e53,                 # SunS */
#     # model 1 */
#     1, 66,
#     0x5375, 0x6e53, 0x7065, 0x6354, 0x6573, 0x7400, 0x0000, 0x0000,    # Mn - SunSpecTest */
#     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
#     0x5465, 0x7374, 0x496e, 0x7665, 0x7274, 0x6572, 0x0000, 0x0000,    # Md - TestInverter */
#     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
#     0x6f70, 0x745f, 0x615f, 0x625f, 0x6300, 0x0000, 0x0000, 0x0000,    # Opt - opt_a_b_c */
#     0x312e, 0x322e, 0x3300, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,    # Vr - 1.2.3 */
#     0x736e, 0x2d31, 0x3233, 0x3435, 0x3637, 0x3839, 0x0000, 0x0000,    # SN - sn-123456789 */
#     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
#     0x0001,
#     -32768,                         # Pad */
#     # model 120 */
#       120, 26,
#     4,
#     7500, 0,
#     7500, 0,
#     400, 0x8000, 0x8000, 0xFE70,  # VArRtgQ1 to Q4, with conversions
#     1,
#     3130, 0xFFFE,                 # ARtg_SF -2 as 0xFFFE
#     0xFC7E, 0x8000, 0x8000, 0x0342,  # PFRtgQ1 (-850) to PFRtgQ4 (850)
#     0xFFFD,                       # PFRtg_SF (-3)
#     0xFFFF, 0x8000,               # WHRtg
#     0xFFFF, 0x8000,               # AhrRtg
#     0xFFFF, 0x8000,               # MaxChaRte
#     0xFFFF, 0x8000,               # MaxDisChaRte
#     0x8000,                       # Pad
#     0xFFFF                        # EndModel
                                  
#                                   ]),
#     ir=ModbusSequentialDataBlock(0, [0]*100),
#     co=ModbusSequentialDataBlock(0, [0]*10),
#     di=ModbusSequentialDataBlock(0, [0]*10),
   
# )

# context = ModbusServerContext(slaves=store, single=True, )

# # Start Modbus RTU server (slave)
# StartSerialServer(
#     context=context,
#     port='/dev/ttyUSB0',  # Change to your serial port
#     baudrate=9600,
#     stopbits=1,
#     bytesize=8,
#     parity='N',
#     timeout=1
# )



#!/usr/bin/env python
# -*- coding: utf_8 -*-
"""
 Modbus TestKit: Implementation of Modbus protocol in python

 (C)2009 - Luc Jean - luc.jean@gmail.com
 (C)2009 - Apidev - http://www.apidev.fr

 This is distributed under GNU LGPL license, see license.txt
"""

import sys

import modbus_tk
import modbus_tk.defines as cst
from modbus_tk import modbus_rtu
import serial

model_1_120 = [
    0x5375, 0x6e53,                 # SunS */
    # model 1 */
    1, 66,
    0x5375, 0x6e53, 0x7065, 0x6354, 0x6573, 0x7400, 0x0000, 0x0000,    # Mn - SunSpecTest */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x5465, 0x7374, 0x496e, 0x7665, 0x7274, 0x6572, 0x0000, 0x0000,    # Md - TestInverter */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x6f70, 0x745f, 0x615f, 0x625f, 0x6300, 0x0000, 0x0000, 0x0000,    # Opt - opt_a_b_c */
    0x312e, 0x322e, 0x3300, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,    # Vr - 1.2.3 */
    0x736e, 0x2d31, 0x3233, 0x3435, 0x3637, 0x3839, 0x0000, 0x0000,    # SN - sn-123456789 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0001,
    0xffff,                         # Pad */
    # model 120 */
      120, 26,
    4,
    7500, 0,
    7500, 0,
    400, 0x8000, 0x8000, 0xFE70,  # VArRtgQ1 to Q4, with conversions
    1,
    3130, 0xFFFE,                 # ARtg_SF -2 as 0xFFFE
    0xFC7E, 0x8000, 0x8000, 0x0342,  # PFRtgQ1 (-850) to PFRtgQ4 (850)
    0xFFFD,                       # PFRtg_SF (-3)
    0xFFFF, 0x8000,               # WHRtg
    0xFFFF, 0x8000,               # AhrRtg
    0xFFFF, 0x8000,               # MaxChaRte
    0xFFFF, 0x8000,               # MaxDisChaRte
    0x8000,                       # Pad
    0xFFFF                        # EndModel
                                  
                                  ]    
 
fronius_inverter = [
    0x5375, 0x6e53, 0x1, 0x41, 0x4672, 0x6f6e, 0x6975, 0x7300, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x4652, 0x4f4e, 0x4955, 0x5320, 0x4563, 0x6f20, 0x3237, 0x2e30, 0x2d33, 0x2d53, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x332e, 0x3237, 0x2e31, 0x2d33, 0x0, 0x0, 0x0, 0x0, 0x302e, 0x332e, 0x3238, 0x2e30, 0x0, 0x0, 0x0, 0x0, 0x3332, 0x3039, 0x3137, 0x3937, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x71, 0x3c, 0x42be, 0x7ae1, 0x41fe, 0x6666, 0x41fd, 0x5c29, 0x41fe, 0x28f5, 0x43cb, 0xe667, 0x43cc, 0x0, 0x43cb, 0x4ccd, 0x436b, 0xb333, 0x436c, 0x199a, 0x436a, 0x0, 0x46af, 0xf000, 0x4247, 0xe147, 0x46af, 0xf10a, 0x4319, 0x0, 0xc2c7, 0xfed2, 0x4c15, 0x6cbc, 0x7fc0, 0x0, 0x7fc0, 0x0, 0x46b8, 0x27ef, 0x7fc0, 0x0, 0x7fc0, 0x0, 0x7fc0, 0x0, 0x7fc0, 0x0, 0x4, 0x4, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x78, 0x1a, 0x4, 0xa8c, 0x1, 0xa8c, 0x1, 0xa8c, 0x8000, 0x8000, 0xf574, 0x1, 0xea6, 0xfffe, 0xfce0, 0x8000, 0x8000, 0x320, 0xfffd, 0xffff, 0x8000, 0xffff, 0x8000, 0xffff, 0x8000, 0xffff, 0x8000, 0x8000, 0x79, 0x1e, 0xa8c, 0xf0, 0x0, 0xffff, 0xffff, 0xa8c, 0xa8c, 0x8000, 0x8000, 0xf574, 0xffff, 0xfce0, 0x8000, 0x8000, 0x320, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x1, 0x0, 0x0, 0x8000, 0x1, 0x1, 0x8000, 0xfffd, 0x8000, 0x8000, 0x7a, 0x2c, 0x7, 0x0, 0x1, 0x0, 0x0, 0x255, 0xb2f0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x8000, 0x8000, 0xffff, 0x8000, 0xffff, 0xffff, 0x0, 0x0, 0x5254, 0x4300, 0x0, 0x0, 0x3001, 0x3574, 0xffff, 0xffff, 0x8000, 0x7b, 0x18, 0x0, 0x0, 0x1, 0x2710, 0x0, 0x0, 0x0, 0x0, 0x3e8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x8000, 0x0, 0x0, 0x0, 0x2, 0x0, 0xfffe, 0xfffd, 0x0, 0xa0, 0x30, 0xfffe, 0xfffe, 0x0, 0x0, 0x0, 0x0, 0x2, 0xffff, 0x1, 0x5374, 0x7269, 0x6e67, 0x2031, 0x0, 0x0, 0x0, 0x0, 0x981, 0xf17c, 0x3ac0, 0x179, 0xbf84, 0x3001, 0x3575, 0x8000, 0x4, 0xffff, 0xffff, 0x2, 0x5374, 0x7269, 0x6e67, 0x2032, 0x0, 0x0, 0x0, 0x0, 0x564, 0xf17c, 0x2153, 0xdb, 0xf339, 0x3001, 0x3575, 0x8000, 0x4, 0xffff, 0xffff,0xffff, 0xffff
]
PORT = '/dev/ttyUSB0'

def main():
    """main"""
    logger = modbus_tk.utils.create_logger(name="console", record_format="%(message)s")

    #Create the server
    server = modbus_rtu.RtuServer(serial.Serial(PORT))

    try:
        logger.info("running...")
        logger.info("enter 'quit' for closing the server")

        server.start()
        slave_0 = server.add_slave(1)
        name = "Sunspec"
        addr = 40000
        slave_0.add_block(name, cst.HOLDING_REGISTERS, addr, 10024)
        slave_0.set_values(name, addr, fronius_inverter )
        
        
        slave_1 = server.add_slave(81)
        name = "Sunspec"
        addr = 40000
        slave_1.add_block(name, cst.HOLDING_REGISTERS, addr, 10024)
        slave_1.set_values(name, addr, fronius_inverter )
        
        
        slave_2 = server.add_slave(82)
        name = "Sunspec"
        addr = 40000
        slave_2.add_block(name, cst.HOLDING_REGISTERS, addr, 10024)
        slave_2.set_values(name, addr, model_1_120 )
        
        
        slave_3 = server.add_slave(83)
        name = "Sunspec"
        addr = 40000
        slave_3.add_block(name, cst.HOLDING_REGISTERS, addr, 10024)
        slave_3.set_values(name, addr, fronius_inverter )
        
        while True:
            cmd = sys.stdin.readline()
            args = cmd.split(' ')

            if cmd.find('quit') == 0:
                sys.stdout.write('bye-bye\r\n')
                break

            elif args[0] == 'add_slave':
                slave_id = int(args[1])
                server.add_slave(slave_id)
                sys.stdout.write('done: slave %d added\r\n' % (slave_id))

            elif args[0] == 'add_block':
                slave_id = int(args[1])
                name = args[2]
                block_type = int(args[3])
                starting_address = int(args[4])
                length = int(args[5])
                slave = server.get_slave(slave_id)
                slave.add_block(name, block_type, starting_address, length)
                sys.stdout.write('done: block %s added\r\n' % (name))

            elif args[0] == 'set_values':
                slave_id = int(args[1])
                name = args[2]
                address = int(args[3])
                values = []
                for val in args[4:]:
                    values.append(int(val))
                slave = server.get_slave(slave_id)
                slave.set_values(name, address, values)
                values = slave.get_values(name, address, len(values))
                sys.stdout.write('done: values written: %s\r\n' % (str(values)))

            elif args[0] == 'get_values':
                slave_id = int(args[1])
                name = args[2]
                address = int(args[3])
                length = int(args[4])
                slave = server.get_slave(slave_id)
                values = slave.get_values(name, address, length)
                sys.stdout.write('done: values read: %s\r\n' % (str(values)))

            else:
                sys.stdout.write("unknown command %s\r\n" % (args[0]))
    finally:
        server.stop()

if __name__ == "__main__":
    main()